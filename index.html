<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Merry Christmas - Interactive 3D Photo Tree</title>
  <meta name="description" content="Create your own 3D Christmas tree with your photos as Polaroid ornaments. Control with hand gestures!">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="256x256" href="/favicon.png">
  <link rel="apple-touch-icon" href="/favicon.png">

  <!-- Image compression library for faster uploads -->
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.min.js"
          integrity="sha384-vEqXxQiIwsHadv9Ch9qL2pG4AJtdjuln33PqsQPA6MPQadu/xkCPUQdQ4uujXQ0g"
          crossorigin="anonymous"></script>

  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-91M63JKGJ6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-91M63JKGJ6');
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Christmas Jingle Bell Background Music (local for security) -->
  <audio id="bgMusic" loop preload="auto">
    <source src="./audio/jingle-bells.mp3" type="audio/mpeg">
  </audio>
  <style>
    /* CSS Custom Properties for Safe Areas & Breakpoints */
    :root {
      /* Safe area insets for notched devices */
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);

      /* Responsive breakpoints - used in Phase 02-04 for media queries */
      --breakpoint-xs: 320px;
      --breakpoint-sm: 480px;
      --breakpoint-md: 768px;
      --breakpoint-lg: 1024px;
      --breakpoint-xl: 1280px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #000000;
      background-color: #000000;
      color: #fff;
      /* iOS Safari viewport height fix: use 100dvh with 100vh fallback */
      min-height: 100vh;
      min-height: 100dvh;
    }

    /* Tab Navigation */
    .tabs {
      display: flex;
      background: #000000;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding-top: var(--safe-top);
      padding-left: var(--safe-left);
      padding-right: var(--safe-right);
    }
    .tab {
      padding: 14px 16px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      font-size: 12px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 6px;
      min-height: 48px;
      flex: 1;
      justify-content: center;
    }
    .tab:hover { background: rgba(212, 175, 55, 0.1); }
    .tab.active {
      border-color: #d4af37;
      color: #d4af37;
      background: rgba(212, 175, 55, 0.1);
    }
    .tab i { font-size: 14px; }

    /* Tablet and up - restore larger tab styling */
    @media (min-width: 768px) {
      .tab {
        padding: 18px 30px;
        font-size: 14px;
        letter-spacing: 1px;
        gap: 8px;
        flex: none;
        justify-content: flex-start;
      }
      .tab i { font-size: 16px; }
    }

    /* Content Areas */
    .content {
      display: none;
      height: 100vh;
      height: 100dvh; /* iOS Safari fix */
      padding-top: calc(60px + var(--safe-top));
    }
    .content.active { display: block; }
    .content iframe {
      width: 100%;
      height: calc(100vh - 60px - var(--safe-top));
      height: calc(100dvh - 60px - var(--safe-top)); /* iOS Safari fix */
      border: none;
    }

    /* Upload Section */
    #upload-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    .upload-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .upload-header h2 {
      color: #d4af37;
      font-size: 28px;
      margin-bottom: 10px;
      font-weight: 400;
      letter-spacing: 2px;
    }
    .upload-header p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }

    /* Dropzone */
    #dropzone {
      border: 2px dashed rgba(212, 175, 55, 0.5);
      border-radius: 12px;
      padding: 50px 30px;
      text-align: center;
      margin: 20px 0;
      background: rgba(0, 0, 0, 0.3);
      transition: all 0.3s;
      cursor: pointer;
    }
    #dropzone:hover, #dropzone.dragover {
      border-color: #d4af37;
      background: rgba(212, 175, 55, 0.1);
    }
    #dropzone i {
      font-size: 48px;
      color: #d4af37;
      margin-bottom: 15px;
    }
    #dropzone p {
      color: rgba(255, 255, 255, 0.8);
      margin: 10px 0;
    }
    #dropzone .btn-select {
      background: #d4af37;
      color: #000;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-top: 15px;
      transition: all 0.3s;
    }
    #dropzone .btn-select:hover {
      background: #e5c04b;
      transform: translateY(-2px);
    }

    /* File Preview */
    #preview-container {
      margin: 25px 0;
    }
    #preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
    }
    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .preview-item .remove {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 24px;
      height: 24px;
      background: rgba(200, 0, 0, 0.8);
      border: none;
      border-radius: 50%;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .preview-item .file-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 5px;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      font-size: 10px;
      color: rgba(255,255,255,0.8);
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    /* Status Bar */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      margin: 20px 0;
    }
    .status-bar .count {
      font-size: 16px;
    }
    .status-bar .count span {
      color: #d4af37;
      font-weight: bold;
    }
    #uploadBtn {
      background: #d4af37;
      color: #000;
      border: none;
      padding: 12px 40px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    #uploadBtn:disabled {
      background: rgba(212, 175, 55, 0.3);
      cursor: not-allowed;
    }
    #uploadBtn:not(:disabled):hover {
      background: #e5c04b;
      transform: translateY(-2px);
    }

    /* Uploaded Gallery */
    #gallery-section {
      margin-top: 40px;
      padding-top: 30px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    #gallery-section h3 {
      color: #d4af37;
      font-size: 18px;
      margin-bottom: 20px;
      font-weight: 400;
      letter-spacing: 1px;
    }
    #gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    .gallery-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid rgba(212, 175, 55, 0.3);
      transition: all 0.3s;
    }
    .gallery-item:hover {
      border-color: #d4af37;
      transform: scale(1.02);
    }
    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .gallery-item .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: rgba(200, 0, 0, 0.9);
      border: none;
      border-radius: 50%;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .gallery-item:hover .delete-btn { opacity: 1; }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: rgba(20, 30, 40, 0.95);
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid rgba(212, 175, 55, 0.3);
      max-width: 400px;
    }
    .modal-content i {
      font-size: 48px;
      color: #4CAF50;
      margin-bottom: 20px;
    }
    .modal-content h3 {
      color: #d4af37;
      margin-bottom: 15px;
    }
    .modal-content p {
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 25px;
    }
    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    .modal-buttons button {
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #d4af37;
      color: #000;
      border: none;
    }
    .btn-secondary {
      background: transparent;
      color: #d4af37;
      border: 1px solid #d4af37;
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(0, 0, 0, 0.3);
      border-top-color: #000;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: rgba(255, 255, 255, 0.5);
    }
    .empty-state i {
      font-size: 48px;
      margin-bottom: 15px;
    }

    input[type="file"] { display: none; }

    /* Upload Status Indicators */
    .file-status {
      position: absolute;
      bottom: 4px;
      left: 4px;
      right: 4px;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      text-align: center;
    }
    .status-done { background: rgba(34,197,94,0.9); }
    .status-failed { background: rgba(239,68,68,0.9); }
    .status-retrying { background: rgba(234,179,8,0.9); }
    .status-compressing { background: rgba(59,130,246,0.9); }
    .status-uploading { background: rgba(139,92,246,0.9); }
    .status-queued { background: rgba(100,116,139,0.9); }

    /* Audio Control Button */
    #audioControl {
      position: fixed;
      bottom: calc(20px + var(--safe-bottom));
      left: calc(20px + var(--safe-left));
      width: 50px;
      height: 50px;
      min-width: 48px;
      min-height: 48px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(212, 175, 55, 0.5);
      color: #d4af37;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      transition: all 0.3s;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }
    #audioControl:hover {
      background: rgba(212, 175, 55, 0.2);
      border-color: #d4af37;
      transform: scale(1.1);
    }
    #audioControl.muted {
      color: rgba(212, 175, 55, 0.4);
      border-color: rgba(212, 175, 55, 0.3);
    }
    #audioControl .pulse {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 2px solid #d4af37;
      animation: audioPulse 2s ease-out infinite;
      opacity: 0;
    }
    #audioControl:not(.muted) .pulse {
      opacity: 1;
    }
    @keyframes audioPulse {
      0% { transform: scale(1); opacity: 0.8; }
      100% { transform: scale(1.5); opacity: 0; }
    }

    /* Hide UI Control Button */
    #hideUiControl {
      position: fixed;
      bottom: calc(20px + var(--safe-bottom));
      left: calc(80px + var(--safe-left));
      width: 50px;
      height: 50px;
      min-width: 48px;
      min-height: 48px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(212, 175, 55, 0.5);
      color: #d4af37;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      transition: all 0.3s;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }
    #hideUiControl:hover {
      background: rgba(212, 175, 55, 0.2);
      border-color: #d4af37;
      transform: scale(1.1);
    }
    #hideUiControl.active {
      border-color: #d4af37;
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
    }
    .tabs.ui-hidden,
    #audioControl.ui-hidden,
    #hideUiControl.ui-hidden {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
  </style>
</head>
<body>
  <!-- Audio Control Button -->
  <button id="audioControl" class="muted" title="Toggle Christmas Music">
    <span class="pulse"></span>
    <i class="fas fa-volume-mute" id="audioIcon"></i>
  </button>

  <!-- Hide UI Control Button -->
  <button id="hideUiControl" title="Hide UI for Recording (H)">
    <i class="fas fa-eye" id="hideIcon"></i>
  </button>

  <!-- Tab Navigation -->
  <div class="tabs">
    <div class="tab active" data-tab="tree">
      <i class="fas fa-tree"></i> Christmas Tree
    </div>
    <div class="tab" data-tab="upload">
      <i class="fas fa-upload"></i> Upload Photos
    </div>
  </div>

  <!-- Christmas Tree Content -->
  <div id="tree" class="content active">
    <iframe src="/src/christmas-tree/index.html" id="tree-iframe"></iframe>
  </div>

  <!-- Upload Content -->
  <div id="upload" class="content">
    <div id="upload-content">
      <div class="upload-header">
        <h2>Upload Your Photos</h2>
        <p>Add your photos to the Christmas tree (max 10 photos, 32MB each)</p>
      </div>

      <!-- Dropzone -->
      <div id="dropzone">
        <i class="fas fa-cloud-upload-alt"></i>
        <p>Drag & drop your photos here</p>
        <p style="font-size: 12px; color: rgba(255,255,255,0.5);">or</p>
        <button class="btn-select" onclick="document.getElementById('fileInput').click()">
          Select Photos
        </button>
        <input type="file" id="fileInput" accept="image/jpeg,image/png,image/gif,image/webp" multiple>
      </div>

      <!-- Preview -->
      <div id="preview-container" style="display: none;">
        <div id="preview"></div>
      </div>

      <!-- Status Bar -->
      <div class="status-bar">
        <div class="count">
          Photos: <span id="uploadedCount">0</span> / <span id="maxPhotos">10</span>
        </div>
        <button id="uploadBtn" disabled>Upload All</button>
      </div>

      <!-- Gallery of Uploaded Photos -->
      <div id="gallery-section">
        <h3><i class="fas fa-images"></i> Your Uploaded Photos</h3>
        <div id="gallery">
          <div class="empty-state">
            <i class="fas fa-image"></i>
            <p>No photos uploaded yet</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="modal">
    <div class="modal-content">
      <i class="fas fa-check-circle"></i>
      <h3>Photos Uploaded!</h3>
      <p>Your photos have been added to the tree.</p>
      <div class="modal-buttons">
        <button class="btn-primary" onclick="viewTree()">View on Tree</button>
        <button class="btn-secondary" onclick="closeModal()">Upload More</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let pendingFiles = [];
    let uploadedPhotos = [];
    let maxPhotos = 10;

    // Elements
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('preview-container');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadedCountEl = document.getElementById('uploadedCount');
    const maxPhotosEl = document.getElementById('maxPhotos');
    const gallery = document.getElementById('gallery');
    const successModal = document.getElementById('successModal');

    // Tab Switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab, .content').forEach(el => el.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      };
    });

    // Load existing photos on page load
    async function loadPhotos() {
      try {
        const res = await fetch('/api/upload/photos');
        const data = await res.json();
        uploadedPhotos = data.photos || [];
        maxPhotos = data.max || 10;
        maxPhotosEl.textContent = maxPhotos;
        updateUploadedCount();
        renderGallery();
      } catch (err) {
        console.error('Failed to load photos:', err);
      }
    }

    function updateUploadedCount() {
      uploadedCountEl.textContent = uploadedPhotos.length;
    }

    function renderGallery() {
      if (uploadedPhotos.length === 0) {
        gallery.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-image"></i>
            <p>No photos uploaded yet</p>
          </div>
        `;
        return;
      }

      gallery.innerHTML = uploadedPhotos.map(photo => `
        <div class="gallery-item" data-id="${photo.id}">
          <img src="${photo.display_url}" alt="Photo" loading="lazy">
          <button class="delete-btn" onclick="deletePhoto(${photo.id})" title="Delete">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `).join('');
    }

    // Drag & Drop
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    // File Input
    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    function handleFiles(files) {
      const remaining = maxPhotos - uploadedPhotos.length;
      const newFiles = Array.from(files)
        .filter(f => f.type.startsWith('image/'))
        .slice(0, remaining - pendingFiles.length);

      pendingFiles = [...pendingFiles, ...newFiles].slice(0, remaining);
      renderPreview();
    }

    function renderPreview() {
      if (pendingFiles.length === 0) {
        previewContainer.style.display = 'none';
        uploadBtn.disabled = true;
        return;
      }

      previewContainer.style.display = 'block';
      uploadBtn.disabled = false;

      preview.innerHTML = pendingFiles.map((file, i) => {
        const url = URL.createObjectURL(file);
        const size = (file.size / 1024 / 1024).toFixed(2);
        return `
          <div class="preview-item" data-file-index="${i}">
            <img src="${url}" alt="${file.name}">
            <button class="remove" onclick="removeFile(${i})">
              <i class="fas fa-times"></i>
            </button>
            <div class="file-info">${size}MB</div>
            <div class="file-status"></div>
          </div>
        `;
      }).join('');
    }

    function removeFile(index) {
      pendingFiles.splice(index, 1);
      renderPreview();
    }

    // Upload Queue with concurrency control
    class UploadQueue {
      constructor(concurrency = 4) {
        this.concurrency = concurrency;
        this.queue = [];
        this.running = 0;
        this.results = [];
        this.onFileProgress = null;
      }

      async add(file, index) {
        return new Promise((resolve) => {
          this.queue.push({ file, index, resolve });
          this.process();
        });
      }

      async process() {
        while (this.running < this.concurrency && this.queue.length > 0) {
          const { file, index, resolve } = this.queue.shift();
          this.running++;

          this.uploadWithRetry(file, index)
            .then(result => {
              this.results.push(result);
              resolve(result);
            })
            .finally(() => {
              this.running--;
              this.process();
            });
        }
      }

      async uploadWithRetry(file, index, retries = 3) {
        const delays = [1000, 2000, 4000]; // Exponential backoff

        for (let attempt = 0; attempt <= retries; attempt++) {
          try {
            return await this.uploadFile(file, index);
          } catch (err) {
            if (attempt === retries) {
              return { success: false, error: err.message, file, index };
            }
            await new Promise(r => setTimeout(r, delays[attempt]));
            this.onFileProgress?.(index, 'retrying', attempt + 1);
          }
        }
      }

      async uploadFile(file, index) {
        const form = new FormData();
        form.append('image', file);

        const res = await fetch('/api/upload', {
          method: 'POST',
          body: form
        });

        const data = await res.json();

        if (!res.ok || !data.success) {
          throw new Error('Upload failed');
        }

        this.onFileProgress?.(index, 'done');
        return { success: true, data: data.data, index };
      }
    }

    // Compress image before upload
    async function compressImage(file) {
      // Skip if already small or non-compressible
      if (file.size < 500 * 1024) return file; // < 500KB, skip

      const options = {
        maxSizeMB: 2,
        maxWidthOrHeight: 1920,
        initialQuality: 0.9,
        useWebWorker: true,
        fileType: 'image/jpeg' // HEICâ†’JPEG conversion
      };

      try {
        return await imageCompression(file, options);
      } catch (err) {
        return file; // Fallback to original on compression failure
      }
    }

    // Update file status in preview
    function updateFileStatus(index, status, attempt) {
      const preview = document.querySelector(`[data-file-index="${index}"]`);
      if (!preview) return;

      const statusEl = preview.querySelector('.file-status') ||
        (() => {
          const el = document.createElement('div');
          el.className = 'file-status';
          preview.appendChild(el);
          return el;
        })();

      const statusMap = {
        'compressing': 'â³ Compressing...',
        'queued': 'â³ Queued',
        'uploading': 'â¬†ï¸ Uploading...',
        'retrying': `ðŸ”„ Retry ${attempt}/3...`,
        'done': 'âœ… Done',
        'failed': 'âŒ Failed'
      };

      statusEl.textContent = statusMap[status] || status;
      statusEl.className = `file-status status-${status}`;
    }

    // Show error for failed uploads
    function showUploadError(failedCount, successCount) {
      const msg = successCount > 0
        ? `${successCount} uploaded, ${failedCount} failed. Tap "Upload All" to retry.`
        : `${failedCount} upload(s) failed. Tap "Upload All" to retry.`;
      alert(msg);
    }

    // Upload with compression and parallel queue
    uploadBtn.addEventListener('click', async () => {
      if (pendingFiles.length === 0) return;

      const totalFiles = pendingFiles.length;
      uploadBtn.disabled = true;

      // Update UI to show compression status
      uploadBtn.innerHTML = '<span class="spinner"></span> Compressing...';

      // Compress all files first
      const compressedFiles = await Promise.all(
        pendingFiles.map(async (file, i) => {
          updateFileStatus(i, 'compressing');
          const compressed = await compressImage(file);
          updateFileStatus(i, 'queued');
          return compressed;
        })
      );

      // Setup queue
      const queue = new UploadQueue(4);
      let completedCount = 0;

      queue.onFileProgress = (index, status, attempt) => {
        updateFileStatus(index, status, attempt);
        if (status === 'done') {
          completedCount++;
          uploadBtn.innerHTML = `<span class="spinner"></span> Uploading ${completedCount}/${totalFiles}...`;
        }
      };

      // Queue all uploads
      uploadBtn.innerHTML = '<span class="spinner"></span> Uploading 0/' + totalFiles + '...';

      const uploadPromises = compressedFiles.map((file, i) => {
        updateFileStatus(i, 'uploading');
        return queue.add(file, i);
      });

      const results = await Promise.allSettled(uploadPromises);

      // Process results
      let successCount = 0;
      const failedIndices = [];

      results.forEach((result, i) => {
        if (result.status === 'fulfilled' && result.value.success) {
          successCount++;
          uploadedPhotos.unshift({
            id: result.value.data.id,
            display_url: result.value.data.display_url
          });
        } else {
          failedIndices.push(i);
        }
      });

      // Handle failures
      if (failedIndices.length > 0) {
        pendingFiles = failedIndices.map(i => pendingFiles[i]);
        showUploadError(failedIndices.length, successCount);
      } else {
        pendingFiles = [];
      }

      renderPreview();
      updateUploadedCount();
      renderGallery();

      uploadBtn.innerHTML = 'Upload All';
      uploadBtn.disabled = pendingFiles.length === 0;

      if (successCount > 0 && failedIndices.length === 0) {
        successModal.classList.add('active');
      }
    });

    // Delete Photo
    async function deletePhoto(id) {
      if (!confirm('Delete this photo?')) return;

      try {
        const res = await fetch(`/api/upload/${id}`, { method: 'DELETE' });
        const data = await res.json();

        if (data.success) {
          uploadedPhotos = uploadedPhotos.filter(p => p.id !== id);
          updateUploadedCount();
          renderGallery();
        }
      } catch (err) {
        console.error('Delete failed:', err);
      }
    }

    // Modal Functions
    function viewTree() {
      closeModal();
      document.querySelectorAll('.tab, .content').forEach(el => el.classList.remove('active'));
      document.querySelector('[data-tab="tree"]').classList.add('active');
      document.getElementById('tree').classList.add('active');
      // Reload tree iframe to fetch new photos
      document.getElementById('tree-iframe').src = document.getElementById('tree-iframe').src;
    }

    function closeModal() {
      successModal.classList.remove('active');
    }

    // Initialize
    loadPhotos();

    // Audio Control
    const bgMusic = document.getElementById('bgMusic');
    const audioControl = document.getElementById('audioControl');
    const audioIcon = document.getElementById('audioIcon');
    let isMuted = true;

    // Set volume BEFORE any play() call to prevent loud burst
    bgMusic.volume = 0.3;

    // Load saved audio preference
    const savedMuted = localStorage.getItem('christmasMusicMuted');
    if (savedMuted === 'false') {
      isMuted = false;
      audioControl.classList.remove('muted');
      audioIcon.className = 'fas fa-volume-up';
    }

    // Toggle audio on button click
    audioControl.addEventListener('click', () => {
      isMuted = !isMuted;
      if (isMuted) {
        bgMusic.pause();
        audioControl.classList.add('muted');
        audioIcon.className = 'fas fa-volume-mute';
      } else {
        bgMusic.play().catch(err => console.log('Audio play failed:', err));
        audioControl.classList.remove('muted');
        audioIcon.className = 'fas fa-volume-up';
      }
      localStorage.setItem('christmasMusicMuted', isMuted);
    });

    // Try to auto-play if user previously enabled
    if (!isMuted) {
      bgMusic.play().catch(() => {
        // Autoplay blocked - wait for user interaction
        isMuted = true;
        audioControl.classList.add('muted');
        audioIcon.className = 'fas fa-volume-mute';
      });
    }

    // Hide UI Control
    const hideUiControl = document.getElementById('hideUiControl');
    const hideIcon = document.getElementById('hideIcon');
    const tabs = document.querySelector('.tabs');
    let isUiHidden = false;
    let hideButtonTimeout;

    function toggleUiVisibility(hidden) {
      isUiHidden = hidden;

      // Toggle main page elements
      tabs.classList.toggle('ui-hidden', hidden);
      audioControl.classList.toggle('ui-hidden', hidden);

      // Update button icon
      hideIcon.className = hidden ? 'fas fa-eye-slash' : 'fas fa-eye';
      hideUiControl.classList.toggle('active', hidden);

      // Send message to iframe (same origin)
      const iframe = document.getElementById('tree-iframe');
      if (iframe && iframe.contentWindow) {
        try {
          iframe.contentWindow.postMessage({ type: 'TOGGLE_UI', hidden }, window.location.origin);
        } catch (e) { /* iframe not ready */ }
      }

      // Hide button instantly when UI is hidden
      if (hidden) {
        clearTimeout(hideButtonTimeout);
        hideUiControl.classList.add('ui-hidden');
      } else {
        clearTimeout(hideButtonTimeout);
        hideUiControl.classList.remove('ui-hidden');
      }
    }

    // Toggle on button click
    hideUiControl.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleUiVisibility(!isUiHidden);
    });

    // Unhide all UI on click anywhere when UI is hidden
    document.addEventListener('click', () => {
      if (isUiHidden) {
        toggleUiVisibility(false);
      }
    });

    // Touch support for mobile - unhide all UI
    document.addEventListener('touchstart', () => {
      if (isUiHidden) {
        toggleUiVisibility(false);
      }
    }, { passive: true });

    // Keyboard shortcut: H key
    document.addEventListener('keydown', (e) => {
      if (e.key.toLowerCase() === 'h' && !e.ctrlKey && !e.metaKey && !e.altKey) {
        toggleUiVisibility(!isUiHidden);
      }
    });

    // Listen for messages from iframe (validate origin)
    window.addEventListener('message', (e) => {
      if (e.origin !== window.location.origin) return;
      if (e.data && e.data.type === 'TOGGLE_UI_FROM_IFRAME') {
        toggleUiVisibility(!isUiHidden);
      }
      // Handle iframe click - unhide all UI
      if (e.data && e.data.type === 'IFRAME_CLICK') {
        if (isUiHidden) {
          toggleUiVisibility(false);
        }
      }
    });
  </script>
</body>
</html>
